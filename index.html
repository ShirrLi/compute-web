<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dashboard | SING Cloud | Next-Gen AI Cloud</title>
    
    <!-- CSS and JS Libraries-->
    <script src="assets/bliss.js"></script>
    <link rel="stylesheet" href="assets/bulma.min.css">
    <script src="assets/jquery-3.7.1.min.js"></script>
    <script>jQuery.noConflict();</script>
    <script src="assets/datatables.min.js"></script>
    <link href="assets/datatables.css" rel="stylesheet">

    <!-- TACC Theme Files -->
    <link href="assets/tacc-theme.css" rel="stylesheet">
    <script src="assets/tacc-theme.js"></script>
    <script src="scripts/sing-api.js"></script>
    <script type="module" src="./scripts/sing-theme.js"></script>
    
    <!-- Font -->
    <script src="https://kit.fontawesome.com/99d5980073.js" crossorigin="anonymous"></script>
</head>
<body>
    <sing-navigation></sing-navigation>

    <section class="section launchpad">
        <div class="container">
            <div class="options">
                <div class="option" onclick="window.location.href='/launch-multi.html'">
                    <div class="image"><i class="fa-solid fa-list-check"></i></div>
                    <div class="text">
                        <div class="line1">Quick Launch</div>
                        <div class="line2">Create a quick runtime as a notebook</div>
                    </div>
                </div>
                <div class="option" onclick="window.location.href='/storage.html'">
                    <div class="image"><i class="fa-solid fa-database"></i></div>
                    <div class="text">
                        <div class="line1">Manage Storage</div>
                        <div class="line2">Access your cloud storage for all jobs</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Job Card -->
    <section class="section content">
        <div class="container">
            <div id="job-cards-container">
            </div>
        </div>
        <script>

        const userHash = 'me';      
        document.addEventListener('DOMContentLoaded', function() {
            function JobCreate(){
                jobs = [];
                pods = [];
                namespace = null;
                // Get namespace for extracting pods data
                api.get('/me').then(response => {
                    namespace = response.username;
                    // console.log('Namespace fetched:', namespace);
                });
                // Get jobs
                api.get('/me/jobs').then(response => {
                        // Map needed job data
                        jobs = response.map(job => ({
                            namespace: namespace,
                            job_name: job.job_id,
                            status: job.status, 
                            start_time: job.start_time,
                            pod_ids: job.pods,
                            pods: []
                        }));
                        // console.log('Jobs fetched:', jobs);

                        // Get pods data
                        return api.get('/me/pods')
                            .then(podsResponse => {
                                pods = podsResponse[namespace];
                                // console.log('Pods fetched:', pods);
                            });
                })
                .then(() => {
                        // Create a map of pod IDs to pod data for faster lookup
                        const podMap = new Map();
                        pods.forEach(pod => {
                            podMap.set(pod["Job Name"] + "-" + pod["Container Name"], pod);
                        });

                        // Match detailed pod data to their jobs using the map
                        jobs.forEach(job => {
                            job.pods = job.pod_ids.map((podId, index) => {
                                const pod = podMap.get(job.job_name + "-" + podId);
                                if (pod) {
                                    return pod;
                                }
                            }).filter(Boolean);
                        });
                        // update status for each job and if there are pods running, the job status is running, otherwise we use the first pod status
                        jobs.forEach(job => {
                            if (job.pods.length === 0) {
                                job.status = "NoPodFound";
                            } else if (job.pods.some(pod => pod.Status === "Running")) {
                                job.status = "Running";
                            } else {
                                job.status = job.pods[0].Status;
                            }
                        });
                        // console.log('Jobs updated:', jobs);

                        // Sort by start time
                        jobs.sort((a, b) => new Date(b.start_time) - new Date(a.start_time));
                        // Render job cards
                        const jobCardsContainer = document.getElementById('job-cards-container');
                        jobCardsContainer.innerHTML = '';
                        jobs.forEach(job => {
                            if (job.pods && job.pods.length > 0) {
                                // console.log("job", job);
                                const jobCard = createJobCard(job);
                                jobCardsContainer.appendChild(jobCard);
                            }
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching jobs/pods:', error);
                    });
            }

            // Create Job card for each job
            function createJobCard(job) {
                    // Job info in Job cards
                    const jobName = job.job_name;
                    const status = job.status;
                    const start_time = job.start_time;

                    const statusClass = getStatusClass(status);
                    const jobId = `job-${jobName.replace(/\s+/g, '-').toLowerCase()}`;

                    // Info prepared for pods
                    const tableId = `table-${jobId}`;
                    const namespace = job.namespace;
                    // const gpu_type = job.gpu_type;
                    const containers = job.pods;
                    const image = containers[0]["Image"];
                    // console.log("containers", containers);

                    // total GPUs for job card
                    let totalGPU = 0;
                    containers.forEach(container => {
                        const gpuRequest = container["GPU Request"];
                        if (gpuRequest && gpuRequest !== 'N/A') {
                            const gpuValue = parseFloat(gpuRequest);
                            if (!isNaN(gpuValue)) {
                                totalGPU += gpuValue;
                            }
                        }
                    });
                    
                    const card = document.createElement('div');
                    card.className = 'box job-card';
                    card.setAttribute('data-job-name', jobName);

                    // store container data in a global variable to avoid JSON serialization issues
                    if (!window.jobContainers) window.jobContainers = {};
                    const jobContainerId = `job_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
                    window.jobContainers[jobContainerId] = containers;

                    card.innerHTML = `
                        <div class="job-card-header" onclick="toggleJobContainers('${jobId}')">
                            <div class="job-header-top">
                                <div class="job-title">
                                    <span class="status-badge ${statusClass}">${status}</span>
                                    <span class="job-name">${jobName}</span>
                                </div>
                                <div class="job-actions">
                                    <div class="job-action-button info" onclick="event.stopPropagation(); showSetupInfo('${jobName}')">
                                        <i class="fa-solid fa-info-circle"></i>
                                        <span>Info</span>
                                    </div>
                                    <!-- ${status === 'Running' ? `
                                        <div class="job-action-button stop" onclick="event.stopPropagation(); stopJob('${jobName}', '${namespace}', '${jobContainerId}')">
                                            <i class="fa-solid fa-stop"></i>
                                            <span>Stop</span>
                                        </div>
                                    ` : ''} -->
                                    <div class="job-action-button danger" onclick="event.stopPropagation(); deleteJob('${jobName}', '${namespace}', '${jobContainerId}')">
                                        <i class="fa-solid fa-trash"></i>
                                        <span>Delete</span>
                                    </div>
                                </div>
                            </div>
                            <div class="job-meta">
                                <div class="job-meta-item">
                                    <i class="fa-solid fa-user job-meta-icon"></i>
                                    <div class="job-meta-value">${namespace}</div>
                                </div>
                                <div class="job-meta-item">
                                    <i class="fa-solid fa-clock job-meta-icon"></i>
                                    <div class="job-meta-value">${start_time}</div>
                                </div>
                                <div class="job-meta-item">
                                    <i class="fa-solid fa-microchip job-meta-icon"></i>
                                    <div class="job-meta-value">${totalGPU || "0"} GPU</div>
                                </div>
                                <div class="job-meta-item">
                                    <i class="fa-solid fa-cube job-meta-icon"></i>
                                    <div class="job-meta-value job-image" title="${image}">${formatImageName(image)}</div>
                                </div>
                            </div>
                        </div>
                        <div id="${jobId}" class="job-containers" style="display: none;">
                            <div class="container-list">
                                <div class="container-list-header">
                                    <div class="container-header-id">Container ID</div>
                                    <div class="container-header-name">Container Name</div>
                                    <div class="container-header-gpu">GPU</div>
                                    <div class="container-header-actions">Actions</div>
                                </div>
                                ${containers.map(container => {
                                    const containerStatusClass = getStatusClass(container["Status"]);
                                    return `
                                        <div class="container-list-item">
                                            <div class="container-item-id">
                                                <div class="horizontal-content">
                                                    <span class="status-badge ${containerStatusClass}">${container["Status"]}</span>
                                                    <span class="container-id-text">${container["Container ID"]}</span>
                                                </div>
                                            </div>
                                            <div class="container-item-name">${container["Container Name"]}</div>
                                            <div class="container-item-gpu">
                                                <div class="horizontal-content">
                                                    <span>${container["GPU Type"]}</span>
                                                    <span class="info-icon" data-info="GPU Request: ${container["GPU Request"]}, GPU Limit: ${container["GPU Limit"]}, CPU Request: ${container["CPU Request"]}, Memory Request: ${container["Memory Request"]}"></span>
                                                </div>
                                            </div>
                                            <div class="container-item-actions">
                                                <div class="actions-container">
                                                    <div class="actions">
                                                        ${containerStatusClass === 'status-completed' ? `
                                                            <div class="action-item" onclick="showContainerLog('${container["Namespace"]}', '${container["Container Name"]}')">
                                                                <i class="fa-regular fa-file"></i>
                                                                <span>Output</span>
                                                            </div>
                                                        ` : ''}
                                                        ${containerStatusClass === 'status-failed' && container["Error Message"] && container["Error Message"] !== 'N/A' ? `
                                                            <div class="action-item" onclick="showErrorMessage('${container["Error Message"].replace(/'/g, "\\'")}')">
                                                                <i class="fa-regular fa-file"></i>
                                                                <span>Error log</span>
                                                            </div>
                                                        ` : ''}
                                                        ${containerStatusClass === 'status-running' ? `
                                                        <div class="action-item" onclick="editContainer('${container["Pod IP"]}', '${container["Container Name"]}', '${container["Status"]}')">
                                                            <i class="pencil-icon"></i>
                                                                <span>Port</span>
                                                            </div>
                                                        ` : ''}
                                                        ${containerStatusClass === 'status-running' ? `
                                                            <div class="action-item" onclick="showSshCommand('${container["SSH Port"]}')">
                                                                <i class="link-icon"></i>
                                                                <span>SSH</span>
                                                            </div>
                                                        ` : ''}
                                                        ${containerStatusClass === 'status-running' ? `
                                                            <div class="action-item" onclick="connectSsh('${container["SSH Port"]}')">
                                                                <i class="terminal-icon"></i>
                                                                <span>Terminal</span>
                                                            </div>
                                                        ` : ''}
                                                        ${containerStatusClass === 'status-running' ? `
                                                            <div class="action-item" onclick="event.stopPropagation(); cloneJob('${jobName}', '${jobContainerId}')">
                                                                <i class="fa-regular fa-clone"></i>
                                                                <span>Clone</span>
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                    
                    return card;
            }


            // Container table
            function fetchPodInfo() {            
                // No longer need DataTable initialization since we're using divs
                // Container styling is handled by CSS
            }
                    
            // Toggle container tables
            window.toggleJobContainers = function(jobId) {
                const containersDiv = document.getElementById(jobId);
                if (containersDiv) {
                    const isVisible = containersDiv.style.display !== 'none';
                    containersDiv.style.display = isVisible ? 'none' : 'block';
                    
                    const jobCardHeader = containersDiv.previousElementSibling;
                    const expandIcon = jobCardHeader.querySelector('.expand-icon i');
                    if (expandIcon) {
                        expandIcon.className = isVisible ? 'fa-solid fa-chevron-down' : 'fa-solid fa-chevron-up';
                    }
                    
                    // No need for table adjustment as we're using divs
                }
            };
                    
            // Container actions
            // edit port mapping
            window.editContainer = function(podIp, containerName, status) {
                if (status === 'Running') {
                    showPortMappingModal(podIp, containerName);
                } else {
                    alert('Cannot edit. The container is not running.');
                }
            };
            
            // show container log
            window.showContainerLog = function(namespace, containerName) {
                api.get(`/me/get-pod-log?namespace=${namespace}&pod_name=${containerName}`)
                    .then(data => {
                        showModal(data.log);
                    })
                    .catch(error => {
                        console.error('Error fetching log:', error);
                    });
            };
            
            // show error message
            window.showErrorMessage = function(errorMessage) {
                showModal(errorMessage);
            };
                    
            // show ssh command
            window.showSshCommand = function(sshPort) {
                // if sshPort is not available, return
                if (sshPort === 'N/A') {
                    alert('SSH port is not available.');
                    return;
                }
                showSshCommandModal(sshPort);
            };
            
            // connect in web
            window.connectSsh = function(sshPort) {
                console.log("sshPort", sshPort);
                if (sshPort !== 'N/A') {
                    api.post('/connect-ssh', { port: sshPort })
                    .then(data => {
                        console.log("data", data);
                        if (data.success) {
                            window.location.href = `/ssh.html?session_id=${data.session_id}`;
                        } else {
                            alert("SSH connection failed.");
                        }
                    })
                    .catch(error => {
                        console.error('Error connecting to SSH:', error);
                    });
                } else {
                    alert("SSH connection is not available.");
                }
            };
                    
            // Job card actions
            // setup info
            window.showSetupInfo = function(jobName) {
                // attention: not implemented yet, will update
                alert(`Setup information for ${jobName}`);
            };
                    
            // stop action
            window.stopJob = function(jobName, namespace, containersId) {
                const containers = window.jobContainers[containersId];
                // if job status is not running, return
                if (containers[0]["Status"] !== 'Running') {
                    alert('The job is not running.');
                    return;
                }
                if (confirm(`Are you sure you want to stop the job ${jobName}?`)) {
                    document.getElementById("overlay").style.display = "block";
                    
                    // attention: here the stop-container API not implemented yet
                    const stopPromises = containers.map(container => {
                        return api.post(`/me/stop-container`, {
                            namespace: container["Namespace"],
                            container_name: container["Container Name"]
                        });
                    });
                    
                    Promise.all(stopPromises)
                        .then(responses => {
                            alert(`Job ${jobName} stopped successfully.`);
                            setTimeout(() => {
                                location.reload();
                            }, 2000);
                        })
                        .catch(error => {
                            console.error('Error stopping job:', error);
                            alert('Error stopping job.');
                            document.getElementById("overlay").style.display = "none";
                        });
                }
            };
                    
            // clone action
            window.cloneJob = function(jobName, containersId) {
                const containers = window.jobContainers[containersId];
                if (!containers || containers.length === 0) {
                    alert('No containers found for this job.');
                    return;
                }
                
                // Get the first container (as specified in the requirements)
                const container = containers[0];
                
                if (container["Status"] !== 'Running') {
                    alert('Cannot commit container that is not running. Container must be in Running state.');
                    return;
                }
                
                // Show the commit modal
                showCommitModal(container);
            };
                    
            function showCommitModal(container) {
                let modal = document.getElementById('commit-modal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'commit-modal';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-background"></div>
                        <div class="modal-content">
                            <div class="box">
                                <h3 class="title is-5">Create Image from Container</h3>
                                <div class="field">
                                    <label class="label">Container</label>
                                    <div class="control">
                                        <input id="commit-container-name" class="input" type="text" readonly>
                                    </div>
                                </div>
                                <div class="field">
                                    <label class="label">Image Name <span class="has-text-danger">*</span></label>
                                    <div class="control">
                                        <input id="commit-image-name" class="input" type="text" placeholder="Enter new image name" required>
                                    </div>
                                    <p class="help">Provide a name for your new image</p>
                                </div>
                                <div class="field">
                                    <label class="label">Image Tag</label>
                                    <div class="control">
                                        <input id="commit-image-tag" class="input" type="text" placeholder="latest" value="latest">
                                    </div>
                                    <p class="help">Optional: Provide a tag for your image (defaults to 'latest')</p>
                                </div>
                                <div class="field">
                                    <label class="label">Description</label>
                                    <div class="control">
                                        <textarea id="commit-description" class="textarea" placeholder="Enter description for your image"></textarea>
                                    </div>
                                </div>
                                <div class="field is-grouped">
                                    <div class="control">
                                        <button id="commit-save-button" class="button is-link">Create Image</button>
                                    </div>
                                    <div class="control">
                                        <button id="commit-cancel-button" class="button is-light">Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button class="modal-close is-large" aria-label="close"></button>
                    `;
                    document.body.appendChild(modal);
                    
                    // Add event listeners
                    modal.querySelector('.modal-close').addEventListener('click', () => {
                        modal.classList.remove('is-active');
                    });
                    modal.querySelector('.modal-background').addEventListener('click', () => {
                        modal.classList.remove('is-active');
                    });
                    document.getElementById('commit-cancel-button').addEventListener('click', () => {
                        modal.classList.remove('is-active');
                    });
                }
                
                // Set container name in the modal
                document.getElementById('commit-container-name').value = container["Container Name"];
                
                // Clear previous inputs
                document.getElementById('commit-image-name').value = '';
                document.getElementById('commit-image-tag').value = 'latest';
                document.getElementById('commit-description').value = '';
                
                // Set up the save button click handler
                const saveButton = document.getElementById('commit-save-button');
                saveButton.onclick = function() {
                    const imageName = document.getElementById('commit-image-name').value.trim();
                    const imageTag = document.getElementById('commit-image-tag').value.trim() || 'latest';
                    const description = document.getElementById('commit-description').value.trim();
                    const podName = container["Container Name"];
                    
                    if (!imageName) {
                        alert('Image name is required');
                        return;
                    }
                    
                    // Close the modal immediately
                    modal.classList.remove('is-active');
                    
                    // Call the API to commit the container
                    api.post('/me/commit-container', {
                        pod_name: podName,
                        image_name: imageName,
                        image_tag: imageTag,
                        description: description
                    })
                    .then(response => {
                        alert(`Image ${imageName}:${imageTag} created successfully. Please go to the Image page to view the image.`);
                    })
                    .catch(error => {
                        console.error('Error committing container:', error);
                        alert(`Error creating image: ${error.message || 'Unknown error'}`);
                    });
                };
                
                // Show the modal
                modal.classList.add('is-active');
            }
                    
            // delete action
            window.deleteJob = function(jobName, namespace, containersId) {
                const containers = window.jobContainers[containersId];
                if (confirm(`Are you sure you want to delete the job ${jobName}?`)) {
                    document.getElementById("overlay").style.display = "block";
                    
                    // delete all containers in the job
                    const deletePromises = containers.map(container => {
                        return api.post(`/me/delete-container`, {
                            namespace: container["Namespace"],
                            container_name: container["Container Name"],
                            job_type: container["Job Type"],
                            job_name: jobName
                        });
                    });
                    
                    Promise.all(deletePromises)
                        .then(responses => {
                            alert(`Job ${jobName} deleted successfully.`);
                            setTimeout(() => {
                                location.reload();
                            }, 2000);
                        })
                        .catch(error => {
                            console.error('Error deleting job:', error);
                            alert('Error deleting job.');
                            document.getElementById("overlay").style.display = "none";
                        });
                }
            };

            function showPortMappingModal(podIp, containerName) {
                const modal = document.getElementById('port-modal');
                const existingMappings = document.getElementById('existing-port-mappings');
                const modalClose = modal.querySelector('.modal-close');
                const modalBackground = modal.querySelector('.modal-background');

                // Clear previous input
                document.getElementById('container-port-input').value = '';

                // Set up the save button click handler
                const saveButton = document.getElementById('save-port-mapping');
                saveButton.onclick = function() {
                    const containerPort = document.getElementById('container-port-input').value;
                    if (containerPort) {
                        api.get(`/port/add_proxy?ip=${podIp}&name=${containerName}&port=${containerPort}`, null, true)
                            .then(response => {
                                const modal = document.getElementById('port-modal');
                                modal.classList.remove('is-active');
                                setTimeout(() => {
                                    showPortMappingModal(podIp, containerName);
                                }, 2);
                                if (typeof response === 'string') {
                                    alert(response);
                                } else if (response.port) {
                                    alert(`Successfully mapped container port ${containerPort} to external port ${response.port}`);
                                } else {
                                    alert('Failed to map port.');
                                }
                            })
                            .catch(error => {
                                if (error.message && error.message.includes('not valid JSON')) {
                                    alert(`Successfully mapped container port ${containerPort}`);
                                    const modal = document.getElementById('port-modal');
                                    modal.classList.remove('is-active');
                                    setTimeout(() => {
                                        showPortMappingModal(podIp, containerName);
                                    }, 2);
                                } else {
                                    console.error('Error mapping port:', error);
                                    alert('Failed to map port.');
                                }
                            });
                    }
                };

                function portMappingHeaderRender() {
                    var header = ["Container Port", "Allocated Port", "Action"];
                    return $.create("thead", { contents: {
                        tag: "tr",
                        contents: header.map((key) =>
                            ({
                                tag: "th",
                                contents: key,
                                style: {
                                    textAlign: 'center'
                                }
                            })
                        )
                    }});
                }

                function portMappingRowRender(mappings) {
                    var header = ["Container Port", "Allocated Port", "Action"];
                    var result = [];
                    mappings.forEach(mapping => {
                        var display = $.create("tr", {
                            contents: header.map((key) =>
                                ({
                                    tag: "td",
                                    contents: (() => {
                                        switch (key) {
                                            case "Action":
                                                return $.create("div", {
                                                    className: "port-mapping-actions",
                                                    contents: [
                                                        {
                                                            tag: "div",
                                                            events: {
                                                                click: (e) => {
                                                                    e.stopPropagation();
                                                                    if (confirm(`Are you sure you want to delete port mapping ${mapping.container_port}?`)) {
                                                                        api.get(`/port/remove_proxy?ip=${podIp}&name=${containerName}&port=${mapping.container_port}`, null, true)
                                                                            .then(response => {
                                                                                alert(`Successfully removed port mapping: ${mapping.container_port}`);                                                                                
                                                                                const modal = document.getElementById('port-modal');
                                                                                modal.classList.remove('is-active');
                                                                                setTimeout(() => {
                                                                                    showPortMappingModal(podIp, containerName);
                                                                                }, 2);
                                                                            })
                                                                            .catch(error => {
                                                                                if (error.message && error.message.includes('not valid JSON')) {
                                                                                    alert(`Successfully removed port mapping: ${mapping.container_port}`);
                                                                                    const modal = document.getElementById('port-modal');
                                                                                    modal.classList.remove('is-active');
                                                                                    setTimeout(() => {
                                                                                        showPortMappingModal(podIp, containerName);
                                                                                    }, 2);
                                                                                } else {
                                                                                    console.error('Error removing port mapping:', error);
                                                                                    alert('Failed to remove port mapping.');
                                                                                }
                                                                            });
                                                                    }
                                                                }
                                                            },
                                                            contents: {
                                                                tag: "i",
                                                                className: "fa-solid fa-trash-alt"
                                                            }
                                                        }
                                                    ]
                                                });
                                            case "Container Port":
                                                return mapping.container_port;
                                            case "Allocated Port":
                                                return mapping.allocated_port;
                                        }
                                    })()
                                })
                            )
                        });
                        result.push(display);
                    });
                    return result;
                }

                // Fetch existing port mappings
                api.get(`/port/get_port?ip=${podIp}`)
                    .then(data => {
                        existingMappings.innerHTML = '';
                        
                        // Create title
                        const titleDiv = document.createElement('div');
                        titleDiv.className = 'content';
                        titleDiv.innerHTML = '<h4 class="title is-6">Existing Mappings</h4>';
                        existingMappings.appendChild(titleDiv);

                        if (data.ports && data.ports.length > 0) {
                            const tableContainer = document.createElement('div');
                            tableContainer.className = 'table-container';
                            existingMappings.appendChild(tableContainer);

                            const table = document.createElement('table');
                            table.className = 'table is-fullwidth is-striped';
                            tableContainer.appendChild(table);

                            // Add header
                            table.appendChild(portMappingHeaderRender());

                            // Add body
                            const tbody = document.createElement('tbody');
                            portMappingRowRender(data.ports).forEach(row => {
                                tbody.appendChild(row);
                            });
                            table.appendChild(tbody);
                        } else {
                            const noDataDiv = document.createElement('p');
                            noDataDiv.textContent = 'No existing port mappings';
                            existingMappings.appendChild(noDataDiv);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching port mappings:', error);
                        existingMappings.textContent = 'Error fetching port mappings.';
                    });
            
                modal.classList.add('is-active');

                // Add close handlers
                modalClose.onclick = hideModal;
                modalBackground.onclick = hideModal;
            }
            
            // Function to show modal
            function showModal(logContent) {
                const modal = document.getElementById('log-modal');
                const logContentElement = document.getElementById('log-content');
                logContentElement.textContent = logContent;
                modal.classList.add('is-active');
            }

            // Function to close modal
            function closeModal() {
                const modal = document.getElementById('log-modal');
                modal.classList.remove('is-active');
            }

            function hideModal() {
                const modal = document.getElementById('port-modal');
                modal.classList.remove('is-active');
            }

            // show SSH command modal
            function showSshCommandModal(sshPort) {
                let modal = document.getElementById('ssh-command-modal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'ssh-command-modal';
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-background"></div>
                        <div class="modal-content">
                            <div class="box">
                                <h3 class="title is-5">SSH Command</h3>
                                <div class="field">
                                    <label class="label">Use this command to connect via SSH:</label>
                                    <div class="control">
                                        <input id="ssh-command" class="input" type="text" readonly>
                                    </div>
                                </div>
                                <button class="button is-primary copy-button">Copy to Clipboard</button>
                            </div>
                        </div>
                        <button class="modal-close is-large" aria-label="close"></button>
                    `;
                    document.body.appendChild(modal);
                    
                    // Add event listeners
                    modal.querySelector('.modal-close').addEventListener('click', () => {
                        modal.classList.remove('is-active');
                    });
                    modal.querySelector('.modal-background').addEventListener('click', () => {
                        modal.classList.remove('is-active');
                    });
                    modal.querySelector('.copy-button').addEventListener('click', () => {
                        const commandInput = document.getElementById('ssh-command');
                        commandInput.select();
                        document.execCommand('copy');
                        alert('Command copied to clipboard!');
                    });
                }
                
                // Set SSH command
                const sshCommand = `ssh root@gw.tacc.ust.hk -p ${sshPort}`;
                document.getElementById('ssh-command').value = sshCommand;
                
                // Show the modal
                modal.classList.add('is-active');
            }

            // job/container status class
            function getStatusClass(status) {
                status = status.toLowerCase();
                if (status === 'running') return 'status-running';
                if (status === 'pending' || status === 'containercreating' || status === 'podinitialized') return 'status-pending';
                if (status === 'failed' || status === 'error' || status === 'crashloopbackoff' || status === 'unschedulable') return 'status-failed';
                if (status === 'completed' || status === 'succeeded') return 'status-completed';
                return 'status-unknown';
            }

            function formatImageName(imagePath) {
                if (!imagePath) return 'N/A';
                const parts = imagePath.split('/');
                if (parts.length >= 2) {
                    return parts[parts.length - 1];
                }
                return imagePath;
            };

            // tooltip
            const tooltip = document.createElement('div');
            tooltip.className = 'gpu-tooltip';
            document.body.appendChild(tooltip);

            // show tooltip when over the icon
            document.addEventListener('mouseover', function(e) {
                if (e.target.classList.contains('info-icon')) {
                    const infoText = e.target.getAttribute('data-info');
                    tooltip.textContent = infoText;
                    tooltip.classList.add('visible');
                    
                    // calculate position
                    const rect = e.target.getBoundingClientRect();
                    const tooltipHeight = tooltip.offsetHeight;
                    const tooltipWidth = tooltip.offsetWidth;
                    
                    let top = rect.top - tooltipHeight - 10;
                    let left = rect.left - (tooltipWidth / 2) + (rect.width / 2);
                    if (top < 10) {
                        top = rect.bottom + 10;
                    }
                    
                    if (left < 10) left = 10;
                    if (left + tooltipWidth > window.innerWidth - 10) {
                        left = window.innerWidth - tooltipWidth - 10;
                    }
                    
                    tooltip.style.top = `${top}px`;
                    tooltip.style.left = `${left}px`;
                }
            });

            document.addEventListener('mouseout', function(e) {
                if (e.target.classList.contains('info-icon')) {
                    tooltip.classList.remove('visible');
                }
            });

            // Add event listeners for modal close
            document.querySelector('.modal-close').addEventListener('click', closeModal);
            document.querySelector('.modal-background').addEventListener('click', closeModal);

            // Fetch and render the table on page load
            JobCreate();
            fetchPodInfo();
        });
        </script>
    </section>

    <footer class="section footer">
        <div class="container">
            <div class="columns content">
                <div class="column items is-3">
                    <div class="item item-title">TACC Workflow</div>
                    <div class="item">Launch & Monitor AI Jobs</div>
                    <div class="item">Access Cloud Storage</div>
                    <div class="item">Manage Code & Scripts</div>
                </div>
                <div class="column items is-3">
                    <div class="item item-title">TACC Space</div>
                    <div class="item">Latest Public Images</div>
                    <div class="item">Public Dataset</div>
                    <div class="item">Discussion Groups</div>
                </div>
                <div class="column items is-3">
                    <div class="item item-title">Research</div>
                    <div class="item">AI-centric Networking</div>
                    <div class="item">Machine Learning Systems</div>
                    <div class="item">Cluster Resource Scheduling</div>
                </div>
                <div class="column items is-3">
                    <div class="item item-title">Company</div>
                    <div class="item">Our Team</div>
                    <div class="item">Careers</div>
                    <div class="item">HKUST iSING Lab</div>
                </div>
            </div>
            <div class="columns is-align-items-center">
                <div class="column is-narrow logo"><img src="assets/tacc-logo.png" /></div>
                <div class="column copyright is-narrow"><span class="text-brand">星畅</span> © 2020–2024</div>
            </div>
        </div>
    </footer>

    <div id="log-modal" class="modal">
        <div class="modal-background"></div>
        <div class="modal-content">
            <div class="box">
                <pre id="log-content"></pre>
            </div>
        </div>
        <button class="modal-close is-large" aria-label="close"></button>
    </div>

    <div id="overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0, 0, 0, 0.5); z-index:1000; text-align:center; color:white; font-size:24px;">
        <div style="position:relative; top:50%; transform:translateY(-50%);">
            Please wait...
        </div>
    </div>

    <div id="port-modal" class="modal">
        <div class="modal-background"></div>
        <div class="modal-content">
            <div class="box">
                <h3 class="title is-5">Port Mapping</h3>
                <div id="existing-port-mappings" class="mb-4"></div>
                <div class="field">
                    <label class="label">Add New Port Mapping</label>
                    <div class="control">
                        <input id="container-port-input" class="input" type="number" placeholder="Enter container port (e.g.8080)">
                    </div>
                    <p class="help">Specify the port number that your application uses inside the container</p>
                </div>
                <div class="field is-grouped">
                    <div class="control">
                        <button id="save-port-mapping" class="button is-link">Map Port</button>
                    </div>
                </div>
            </div>
        </div>
        <button class="modal-close is-large" aria-label="close"></button>
    </div>
    
    
    
    

</body>
</html>