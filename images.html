<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Image Repository | SING Cloud | Next-Gen AI Cloud</title>
    
    <!-- CSS and JS Libraries-->
    <script src="assets/bliss.js"></script>
    <link rel="stylesheet" href="assets/bulma.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>jQuery.noConflict();</script>
    <script src="https://cdn.datatables.net/v/bm/dt-2.1.2/datatables.min.js"></script>
    <link href="assets/datatables.css" rel="stylesheet">

    <!-- TACC Theme files -->
    <link href="assets/tacc-theme.css" rel="stylesheet">
    <link href="assets/images-style.css" rel="stylesheet">
    <script src="assets/tacc-theme.js"></script>
    <script src="scripts/sing-api.js"></script>
    <script type="module" src="./scripts/sing-theme.js"></script>
    
    <!-- Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/99d5980073.js" crossorigin="anonymous"></script>
</head>
<body>
    <sing-navigation></sing-navigation>

    <!-- Top fixed progress bar -->
    <div id="topProgressContainer">
        <div class="progress-header">
            <div class="progress-title">
                <span id="topProgressTitle">Upload progress</span>
            </div>
            <div class="progress-actions">
                <div id="topProgressPercentage" class="has-text-weight-bold">0%</div>
                <i id="cancelUpload" class="fas fa-times-circle" title="Cancel upload"></i>
            </div>
        </div>
        <progress id="topProgressBar" class="progress is-primary" value="0" max="100"></progress>
        <p id="topProgressStatus" class="has-text-centered">Preparing upload...</p>
        <div id="operationMessage">Operation in progress. Please wait until completion.</div>
    </div>

    <section class="section content"> 
        <div class="container">
            <h1 class="title">Available Images</h1>
            <p class="subtitle">Browse all available images in the TACC repository.</p>
            
            <!-- Public Image Repository Section -->
            <div class="repository-section">
                <div class="repository-header">
                    <i class="fas fa-globe-americas mr-2"></i> Public Image Repository
                </div>
                <div class="repository-content">
                    <div id="deleteResultInPublic" class="notification is-hidden mb-4"></div>
                    <div class="filter-search-box">
                        <div class="field">
                            <label class="label">Filter/Search</label>
                            <div class="control has-icons-left">
                                <input id="publicSearchInput" class="input" type="text" placeholder="Filter by name, tag, or description...">
                                <span class="icon is-small is-left">
                                    <i class="fas fa-search"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                    <table id="publicImageTable" class="image-table">
                        <thead>
                            <tr>
                                <th>Image Repository</th>
                                <th>Image Name</th>
                                <th>Tag</th>
                                <th>Size</th>
                                <th>Last Updated</th>
                                <th>Details</th>
                                <th>Actions</th>
                                <th>Label</th>
                            </tr>
                        </thead>
                        <tbody id="publicImageTableBody"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Private Image Repository Section -->
            <div class="repository-section">
                <div class="repository-header">
                    <i class="fas fa-lock mr-2"></i> Private Image Repository
                </div>
                <div class="repository-content">
                    <div id="deleteResultInPrivate" class="notification is-hidden mb-4"></div>
                    <div class="filter-search-box">
                        <div class="field">
                            <label class="label">Filter/Search</label>
                            <div class="control has-icons-left">
                                <input id="privateSearchInput" class="input" type="text" placeholder="Filter by name, tag, or description...">
                                <span class="icon is-small is-left">
                                    <i class="fas fa-search"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                    <table id="privateImageTable" class="image-table">
                        <thead>
                            <tr>
                                <th>Source</th>
                                <th>Image Name</th>
                                <th>Tag</th>
                                <th>Size</th>
                                <th>Last Updated</th>
                                <th>Details</th>
                                <th>Actions</th>
                                <th>Label</th>
                            </tr>
                        </thead>
                        <tbody id="privateImageTableBody"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Add New Images Section -->
            <div class="add-images-container">
                <button id="addImagesBtn" class="add-button">
                    <i class="fas fa-plus"></i> Add New Images
                </button>
                
                <div id="uploadOptions" class="upload-tab" style="display: none;">
                    <div class="tab-nav">
                        <div class="tab-item active" data-tab="localUpload">
                            <i class="fas fa-upload mr-2"></i>Local Upload
                        </div>
                        <div class="tab-item" data-tab="fetchUrl">
                            <i class="fas fa-cloud-download-alt mr-2"></i>Fetch from URLs
                        </div>
                    </div>
                    
                    <div class="tab-content">
                        <!-- Local Upload Tab -->
                        <div id="localUpload" class="tab-pane active">
                            <form id="uploadForm" enctype="multipart/form-data">
                                <div class="field">
                                    <label class="label"><b>Upload Type</b></label>
                                    <div class="control upload-type-radio">
                                        <label class="radio-container" for="dockerTarRadio">
                                            <input type="radio" name="uploadType" id="dockerTarRadio" value="docker-tar" checked>
                                            <span class="radio-label">Docker image file</span>
                                            
                                        </label>
                                        <label class="radio-container" for="dockerfilePackageRadio">
                                            <input type="radio" name="uploadType" id="dockerfilePackageRadio" value="dockerfile-package">
                                            <span class="radio-label">Dockerfile project package</span>
                                            
                                        </label>
                                    </div>
                                </div>
                                
                                <div id="dockerTarUpload" class="upload-type-container">
                                    <div class="field">
                                        <label class="label"><b>Select Image File (.tar)</b></label>
                                        <div class="file-input-wrapper">
                                            <input type="file" name="file" id="fileInput" accept=".tar" required>
                                        </div>
                                        <p class="help">image tar file exported by <code>docker save</code></p>
                                    </div>
                                </div>
                                
                                <div id="dockerfileUpload" class="upload-type-container" style="display: none;">
                                    <div class="field">
                                        <label class="label"><b>Select Project Package (.zip/.rar)</b></label>
                                        <div class="file-input-wrapper">
                                            <input type="file" name="project-file" id="projectFileInput" accept=".zip,.rar" required>
                                        </div>
                                        <p class="help">compressed project package including a <code>Dockerfile</code></p>
                                    </div>
                                </div>
                                
                                <div class="control mt-2">
                                    <button type="button" id="uploadButton" class="button is-primary">
                                        <i class="fas fa-upload mr-2"></i>Upload Image
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Fetch from URLs Tab -->
                        <div id="fetchUrl" class="tab-pane" style="display: none;">
                            <!-- 
                            <div class="input-row">
                                <div class="auth-dropdown">
                                    <label class="label">Select private image registry auth</label>
                                    <div class="select is-fullwidth">
                                        <select id="registryAuth">
                                            <option value="" selected>Select registry auth</option>
                                        </select>
                                    </div>
                                    <p class="help">Choose authentication for private registries</p>
                                </div>
                                <button id="addAuthBtn" class="button">
                                    <i class="fas fa-plus"></i> Registry Auth
                                </button>
                            </div>
                            -->
                            <div class="field">
                                <label class="label"><b>Image URL</b></label>
                                <div class="control has-icons-left">
                                    <input type="text" id="urlInput" class="input" placeholder="e.g., docker.io/username/image:tag">
                                    <span class="icon is-small is-left">
                                        <i class="fas fa-link"></i>
                                    </span>
                                </div>
                                <p class="help">URL of image in public dockerhub repository</p>
                            </div>
                            <div class="control">
                                <button type="button" id="fetchButton" class="button is-primary">
                                    <i class="fas fa-cloud-download-alt mr-2"></i>Fetch Image
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="uploadResult" class="notification is-hidden"></div>
                </div>
            </div>
        </div>
    </section>

    <footer class="section footer">
        <div class="container">
            <div class="columns content">
                <div class="column items is-3">
                    <div class="item item-title">TACC Workflow</div>
                    <div class="item">Launch & Monitor AI Jobs</div>
                    <div class="item">Access Cloud Storage</div>
                    <div class="item">Manage Code & Scripts</div>
                </div>
                <div class="column items is-3">
                    <div class="item item-title">TACC Space</div>
                    <div class="item">Latest Public Images</div>
                    <div class="item">Public Dataset</div>
                    <div class="item">Discussion Groups</div>
                </div>
                <div class="column items is-3">
                    <div class="item item-title">Research</div>
                    <div class="item">AI-centric Networking</div>
                    <div class="item">Machine Learning Systems</div>
                    <div class="item">Cluster Resource Scheduling</div>
                </div>
                <div class="column items is-3">
                    <div class="item item-title">Company</div>
                    <div class="item">Our Team</div>
                    <div class="item">Careers</div>
                    <div class="item">HKUST iSING Lab</div>
                </div>
            </div>
            <div class="columns is-align-items-center">
                <div class="column is-narrow logo"><img src="assets/tacc-logo.png" /></div>
                <div class="column copyright is-narrow"><span class="text-colored">星畅</span> © 2020–2024</div>
            </div>
        </div>
    </footer>

    <script>
        // Variable to store the current XHR request for cancellation
        let currentUploadXHR = null;
        
        // frozen effect when uploading or fetching images
        function disableAllButtons() {
            // frozen overlay to main content
            document.querySelector('.container').classList.add('upload-frozen', 'active');

            // disable functions in pages
            document.querySelectorAll('.control mt-2').forEach(button => {
                button.style.pointerEvents = 'none';
            });
            document.querySelectorAll('.tab-content').forEach(button => {
                button.style.pointerEvents = 'none';
            });
            document.querySelectorAll('.view-button').forEach(button => {
                button.style.pointerEvents = 'none';
            });
            document.querySelectorAll('.action-buttons a').forEach(link => {
                link.style.pointerEvents = 'none';
            });
            document.querySelectorAll('.add-button').forEach(button => {
                button.style.pointerEvents = 'none';
            });
            document.querySelectorAll('input[type="file"]').forEach(input => {
                input.style.pointerEvents = 'none';
            });
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.style.pointerEvents = 'none';
            });
            document.querySelectorAll('.tab-item').forEach(tab => {
                tab.style.pointerEvents = 'none';
            });
            document.querySelectorAll('input[type="text"]').forEach(input => {
                input.style.pointerEvents = 'none';
            });
        }
        
        function enableAllButtons() {
            // Remove frozen overlay effect from main content
            document.querySelector('.container').classList.remove('upload-frozen', 'active');
            
            // Re-enable all buttons
            document.querySelectorAll('.control mt-2').forEach(button => {
                button.style.pointerEvents = '';
            });
            document.querySelectorAll('.tab-content').forEach(button => {
                button.style.pointerEvents = '';
            });
            document.querySelectorAll('.view-button').forEach(button => {
                button.style.pointerEvents = '';
            });
            document.querySelectorAll('.action-buttons a').forEach(link => {
                link.style.pointerEvents = '';
            });
            document.querySelectorAll('.add-button').forEach(button => {
                button.style.pointerEvents = '';
            });
            document.querySelectorAll('input[type="file"]').forEach(input => {
                input.style.pointerEvents = '';
            });
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.style.pointerEvents = '';
            });
            document.querySelectorAll('.tab-item').forEach(tab => {
                tab.style.pointerEvents = '';
            });
            document.querySelectorAll('input[type="text"]').forEach(input => {
                input.style.pointerEvents = '';
            });
            
        }

        // Fetch and render images from API
        document.addEventListener('DOMContentLoaded', function() {
            fetchImageInfo();
            
            // Setup cancel upload button
            document.getElementById("cancelUpload").addEventListener("click", function() {
                if (currentUploadXHR) {
                    // Abort the current XHR request
                    currentUploadXHR.abort();
                    
                    // Hide progress modal
                    document.getElementById("topProgressContainer").classList.remove("visible");
                    
                    // Re-enable all buttons
                    enableAllButtons();
                    
                    // Reset current XHR reference
                    currentUploadXHR = null;
                }
            });
            
            // Add Images
            document.getElementById("addImagesBtn").addEventListener("click", function() {
                const uploadOptions = document.getElementById("uploadOptions");
                if (uploadOptions.style.display === "none" || uploadOptions.style.display === "") {
                    uploadOptions.style.display = "block";
                } else {
                    uploadOptions.style.display = "none";
                }
            });
            
            // Tab
            document.querySelectorAll('.tab-item').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    document.querySelectorAll('.tab-pane').forEach(pane => pane.style.display = 'none');
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(tabId).style.display = 'block';
                });
            });
            
            // Upload Type Radio Change
            document.querySelectorAll('input[name="uploadType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const selectedType = this.value;
                    document.querySelectorAll('.upload-type-container').forEach(container => {
                        container.style.display = 'none';
                    });
                    // Show the selected upload container
                    if (selectedType === "docker-tar") {
                        document.getElementById("dockerTarUpload").style.display = "block";
                    } else if (selectedType === "dockerfile-package") {
                        document.getElementById("dockerfileUpload").style.display = "block";
                    }
                });
            });
            
            // File input validation
            document.getElementById('fileInput').addEventListener('change', function() {
                const file = this.files[0];
                if (file && !file.name.toLowerCase().endsWith('.tar')) {
                    alert("Please select a valid .tar file");
                    this.value = '';
                }
            });
            document.getElementById('projectFileInput').addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const fileName = file.name.toLowerCase();
                    if (!fileName.endsWith('.zip') && !fileName.endsWith('.rar')) {
                        alert("Only .zip and .rar files are supported for project packages");
                        this.value = '';
                    }
                }
            });
            
            // Search for public images
            document.getElementById('publicSearchInput').addEventListener('keyup', function() {
                filterTable('publicImageTableBody', this.value);
            });
            
            // Search for private images
            document.getElementById('privateSearchInput').addEventListener('keyup', function() {
                filterTable('privateImageTableBody', this.value);
            });
            
            // Upload from local for private images
            document.getElementById("uploadButton").addEventListener("click", function() {
                const uploadType = document.querySelector('input[name="uploadType"]:checked').value;
                let fileInput;
                let formData = new FormData();
                let apiEndpoint;

                // Hide previous result notification
                const uploadResult = document.getElementById("uploadResult");
                uploadResult.classList.add("is-hidden");
                
                // Setup center progress modal
                const topProgressContainer = document.getElementById("topProgressContainer");
                const topProgressBar = document.getElementById("topProgressBar");
                const topProgressPercentage = document.getElementById("topProgressPercentage");
                const topProgressStatus = document.getElementById("topProgressStatus");
                const topProgressTitle = document.getElementById("topProgressTitle");
                
                // Configure and show progress modal
                topProgressTitle.textContent = "Upload progress";
                topProgressBar.value = 0;
                topProgressPercentage.textContent = "0%";
                topProgressStatus.textContent = "Preparing upload...";
                topProgressContainer.classList.add("visible");
                
                // Disable all buttons during upload
                disableAllButtons();
                
                if (uploadType === "docker-tar") {
                    fileInput = document.getElementById("fileInput").files[0];
                    if (!fileInput) {
                        alert("Please select a .tar file");
                        topProgressContainer.classList.remove("visible");
                        enableAllButtons();
                        return;
                    }
                    if (!fileInput.name.toLowerCase().endsWith('.tar')) {
                        alert("Please select a valid .tar file");
                        topProgressContainer.classList.remove("visible");
                        enableAllButtons();
                        return;
                    }

                    formData.append("file", fileInput);
                    formData.append('tag', '1.0');
                    const imageName = fileInput.name.split('.').slice(0, -1).join('.'); // remove the extension
                    formData.append('image-name', imageName);
                    apiEndpoint = '/me/upload-image-tar';
                } else if (uploadType === "dockerfile-package") {
                    fileInput = document.getElementById("projectFileInput").files[0];
                    if (!fileInput) {
                        alert("Please select a project package");
                        topProgressContainer.classList.remove("visible");
                        enableAllButtons();
                        return;
                    }
                    
                    // Validate file extension for project package
                    const fileName = fileInput.name.toLowerCase();
                    if (!fileName.endsWith('.zip') && !fileName.endsWith('.rar')) {
                        alert("Only .zip and .rar files are supported for project packages");
                        topProgressContainer.classList.remove("visible");
                        enableAllButtons();
                        return;
                    }

                    formData.append("file", fileInput);
                    formData.append('tag', '1.0');
                    const imageName = fileInput.name.split('.').slice(0, -1).join('.'); // remove the extension
                    formData.append('image-name', imageName);
                    apiEndpoint = '/me/upload-dockerfile';
                }
                
                // update progress status with file info
                topProgressStatus.textContent = `Uploading ${fileInput.name} (${formatFileSize(fileInput.size)})`;
                
                // create and configure XHR for progress tracking
                const xhr = new XMLHttpRequest();
                // Store XHR reference for cancellation
                currentUploadXHR = xhr;
                
                xhr.open('POST', api.baseUrl + apiEndpoint, true);
                if (api.token) {
                    xhr.setRequestHeader('Authorization', 'Bearer ' + api.token);
                }
                xhr.upload.onprogress = function(e) {
                    if (e.lengthComputable) {
                        const percentComplete = Math.round((e.loaded / e.total) * 100);
                        
                        // update progress bar
                        topProgressBar.value = percentComplete;
                        topProgressPercentage.textContent = percentComplete + "%";
                        
                        if (percentComplete < 25) {
                            topProgressStatus.textContent = `Starting upload: ${formatFileSize(e.loaded)} of ${formatFileSize(e.total)}`;
                        } else if (percentComplete < 50) {
                            topProgressStatus.textContent = `Uploading: ${formatFileSize(e.loaded)} of ${formatFileSize(e.total)}`;
                        } else if (percentComplete < 90) {
                            topProgressStatus.textContent = `Transferring: ${formatFileSize(e.loaded)} of ${formatFileSize(e.total)}`;
                        } else {
                            topProgressStatus.textContent = `Finalizing: ${formatFileSize(e.loaded)} of ${formatFileSize(e.total)}`;
                        }
                    }
                };
                
                // Upload completed
                xhr.onload = function() {
                    topProgressContainer.classList.remove("visible");
                    uploadResult.classList.remove("is-hidden");
                    
                    // re-enable all buttons
                    enableAllButtons();
                    
                    // Reset current XHR reference
                    currentUploadXHR = null;
                    
                    if (xhr.status >= 200 && xhr.status < 300) {
                        try {
                            const response = JSON.parse(xhr.responseText);
                            uploadResult.classList.remove("is-danger");
                            uploadResult.classList.add("is-success");
                            uploadResult.textContent = response.message || "Upload successful";
                            // refresh image list
                            fetchImageInfo();
                        } catch (e) {
                            uploadResult.classList.remove("is-success");
                            uploadResult.classList.add("is-danger");
                            uploadResult.textContent = "Error processing server response";
                        }
                    } else {
                        uploadResult.classList.remove("is-success");
                        uploadResult.classList.add("is-danger");
                        try {
                            const response = JSON.parse(xhr.responseText);
                            uploadResult.textContent = response.error || "Upload failed";
                        } catch (e) {
                            uploadResult.textContent = "Upload failed: " + xhr.status;
                        }
                    }
                };
                
                // upload error
                xhr.onerror = function() {
                    topProgressContainer.classList.remove("visible");
                    uploadResult.classList.remove("is-hidden", "is-success");
                    uploadResult.classList.add("is-danger");
                    uploadResult.textContent = "Network error during upload";
                    
                    // re-enable all buttons
                    enableAllButtons();
                    
                    // Reset current XHR reference
                    currentUploadXHR = null;
                };
                
                // cancel event
                xhr.onabort = function() {
                    // console.log("Upload aborted by user");
                };
                
                // Start the upload
                xhr.send(formData);
            });

            // Fetch from URL for private images
            document.getElementById("fetchButton").addEventListener("click", function() {
                const url = document.getElementById("urlInput").value;
                // const registryAuth = document.getElementById("registryAuth").value; // Temporarily commented out
                
                if (!url) {
                    alert("Please enter a URL");
                    return;
                }
                
                // hide previous result notification
                const uploadResult = document.getElementById("uploadResult");
                uploadResult.classList.add("is-hidden");
                
                // setup center progress modal
                const topProgressContainer = document.getElementById("topProgressContainer");
                const topProgressBar = document.getElementById("topProgressBar");
                const topProgressPercentage = document.getElementById("topProgressPercentage");
                const topProgressStatus = document.getElementById("topProgressStatus");
                const topProgressTitle = document.getElementById("topProgressTitle");
                
                // configure and show progress modal
                topProgressTitle.textContent = "Fetch progress";
                topProgressBar.value = 0;
                topProgressBar.classList.remove("is-primary");
                topProgressBar.classList.add("is-info");
                topProgressPercentage.textContent = "0%";
                topProgressStatus.textContent = "Initializing fetch...";
                topProgressContainer.classList.add("visible");
                
                // disable all buttons during fetch
                disableAllButtons();
                
                // simulated progress for demo since the API is not ready yet
                let progress = 0;
                const interval = setInterval(() => {
                    progress += 5;
                    if (progress <= 100) {
                        // update progress bar
                        topProgressBar.value = progress;
                        topProgressPercentage.textContent = progress + "%";
                        
                        if (progress < 20) {
                            topProgressStatus.textContent = "Connecting to registry...";
                        } else if (progress < 50) {
                            topProgressStatus.textContent = "Downloading image...";
                        } else if (progress < 80) {
                            topProgressStatus.textContent = "Processing image...";
                        } else {
                            topProgressStatus.textContent = "Finalizing...";
                        }
                    } else {
                        clearInterval(interval);
                        topProgressContainer.classList.remove("visible");
                        
                        // reset progress bar class for future use
                        topProgressBar.classList.remove("is-info");
                        topProgressBar.classList.add("is-primary");
                        
                        // Show result
                        uploadResult.classList.remove("is-hidden");
                        uploadResult.classList.add("is-warning");
                        uploadResult.textContent = "API for fetching images from URL is not ready yet.";
                        
                        // Re-enable all buttons
                        enableAllButtons();
                        
                        // Refresh image list (would be done after actual fetch)
                        // fetchImageInfo();
                    }
                }, 200);
                
                // not ready yet
                alert("fetch image from url");
                return;
                
                /* not ready yet
                api.post(`/me/fetch-image`, {
                    url: url,
                    // registry_auth: registryAuth
                })
                .then(data => {
                    topProgressContainer.classList.remove("visible");
                    uploadResult.classList.remove("is-hidden");
                    uploadResult.classList.add(data.error ? "is-danger" : "is-success");
                    uploadResult.textContent = data.message || data.error;
                    // Re-enable all buttons
                    enableAllButtons();
                    // Refresh image list after fetch
                    fetchImageInfo();
                })
                .catch(error => {
                    topProgressContainer.classList.remove("visible");
                    console.log("Error fetching image:", error);
                    uploadResult.classList.remove("is-hidden");
                    uploadResult.classList.add("is-danger");
                    uploadResult.textContent = "Error fetching image.";
                    // Re-enable all buttons
                    enableAllButtons();
                });
                */
            });
        });
        
        // format file size in a human-readable format
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function filterTable(tableBodyId, query) {
            const tableBody = document.getElementById(tableBodyId);
            const rows = tableBody.getElementsByTagName('tr');
            const lowerQuery = query.toLowerCase();
            
            for (let i = 0; i < rows.length; i++) {
                const rowText = rows[i].textContent.toLowerCase();
                if (rowText.includes(lowerQuery)) {
                    rows[i].style.display = '';
                } else {
                    rows[i].style.display = 'none';
                }
            }
        }

        function fetchImageInfo() {
            api.get(`/me/images`)
                .then(data => {
                    const publicTableBody = document.querySelector('#publicImageTableBody');
                    const privateTableBody = document.querySelector('#privateImageTableBody');
                    
                    publicTableBody.innerHTML = ''; // Clear existing data
                    privateTableBody.innerHTML = ''; // Clear existing data

                    // Traverse all repositories dynamically
                    for (const image of data.images) {
                        const isPublic = image.registry_host.includes('public') || image.registry_host.includes('10.100.100.1:5000');
                        const tableBody = isPublic ? publicTableBody : privateTableBody;
                        
                        const row = document.createElement('tr');
                        const size = image.size + "GB";
                        
                        if (isPublic) {
                            row.innerHTML = `
                                <td>${image.registry_host}</td>
                                <td>${image.name}</td>
                                <td>${image.tag}</td>
                                <td>${size}</td>
                                <td>${new Date(image.inserted_at).toLocaleString()}</td>
                                <td><a href="#" class="view-button" onclick="showDetails('${encodeURIComponent(JSON.stringify(image))}')"><i class="fas fa-circle-info"></i> View</a></td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="#" class="create-from-label" data-repository="${image.registry_host}" data-image="${image.name}" data-tag="${image.tag}" data-details='${encodeURIComponent(JSON.stringify(image))}'><i class="fas fa-square-plus"></i>Create from</a>
                                        <a href="#" class="delete-button" data-repository="${image.registry_host}" data-image="${image.name}" data-tag="${image.tag}" data-digest="${image.digest}"><i class="fas fa-trash"></i> Delete</a>
                                    </div>
                                </td>
                                <td><span class="label-badge"><i class="fas fa-tag mr-1"></i>Models</span></td>
                            `;
                        } else {
                            // Determine source (Tar file, Google Cloud, etc.)
                            const source = determineSource(image);
                            row.innerHTML = `
                                <td>${source}</td>
                                <td>${image.name}</td>
                                <td>${image.tag}</td>
                                <td>${size}</td>
                                <td>${new Date(image.inserted_at).toLocaleString()}</td>
                                <td><a href="#" class="view-button" onclick="showDetails('${encodeURIComponent(JSON.stringify(image))}')"><i class="fas fa-circle-info"></i> View</a></td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="#" class="create-from-label" data-repository="${image.registry_host}" data-image="${image.name}" data-tag="${image.tag}" data-details='${encodeURIComponent(JSON.stringify(image))}'><i class="fas fa-square-plus"></i>Create from</a>
                                        <a href="#" class="delete-button" data-repository="${image.registry_host}" data-image="${image.name}" data-tag="${image.tag}" data-digest="${image.digest}"><i class="fas fa-trash"></i> Delete</a>
                                    </div>
                                </td>
                                <td><span class="label-badge"><i class="fas fa-tag mr-1"></i>Models</span></td>
                            `;
                        }
                        tableBody.appendChild(row);
                    }
                    
                    // "Create from" buttons
                    document.querySelectorAll('.create-from-label').forEach(label => {
                        label.addEventListener('click', function(e) {
                            // Get data attributes
                            const repository = this.getAttribute('data-repository');
                            const imageName = this.getAttribute('data-image');
                            const tag = this.getAttribute('data-tag');
                            const encodedDetails = this.getAttribute('data-details');
                            
                            if (encodedDetails) {
                                const tagData = JSON.parse(decodeURIComponent(encodedDetails));
                                // Add default_entrypoint and default_ports to URL if available
                                let url = `launch-new.html?repository=${encodeURIComponent(repository)}&image=${encodeURIComponent(imageName)}&tag=${encodeURIComponent(tag)}`;
                                if (tagData.default_entrypoint) {
                                    url += `&entrypoint=${encodeURIComponent(tagData.default_entrypoint)}`;
                                }
                                if (tagData.default_port) {
                                    url += `&ports=${encodeURIComponent(tagData.default_port)}`;
                                }
                                // Navigate to the launch-new page
                                window.location.href = url;
                            } else {
                                // Fallback to basic URL if data not found
                                const url = `launch-new.html?repository=${encodeURIComponent(repository)}&image=${encodeURIComponent(imageName)}&tag=${encodeURIComponent(tag)}`;
                                window.location.href = url;
                            }
                            // Prevent the default behavior
                            e.preventDefault();
                        });
                    });
                    
                    // Delete image buttons
                    document.querySelectorAll('.delete-button').forEach(button => {
                        button.addEventListener('click', function(e) {
                            e.preventDefault();
                            
                            const repository = this.getAttribute('data-repository');
                            const imageName = this.getAttribute('data-image');
                            const tag = this.getAttribute('data-tag');
                            const digest = this.getAttribute('data-digest');
                            
                            if (confirm(`Are you sure you want to delete the image ${imageName}:${tag}?`)) {
                                deleteImage(repository, imageName, tag, digest);
                            }
                        });
                    });
                })
                .catch(error => console.error('Error fetching image data:', error));
        }
        
        function deleteImage(registry_host, name, tag, digest) {
            console.log("Deleting image:", registry_host, name, tag, digest);
            let resultNotificationId;
            if (registry_host.includes('10.100.100.1:5000')) {
                resultNotificationId = "deleteResultInPublic";
            } else {
                resultNotificationId = "deleteResultInPrivate";
            }
            // const resultNotification = document.getElementById(resultNotificationId);
            // resultNotification.classList.remove("is-hidden", "is-danger", "is-success");
            // resultNotification.classList.add("is-info");
            // resultNotification.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Deleting image...';
            
            // disableAllButtons();
            
            api.post('/me/delete-image', {
                digest: digest,
                registry_host: registry_host,
                name: name,
                tag: tag
            })
            .then(response => {
                // display success message
                const resultNotification = document.getElementById(resultNotificationId);
                resultNotification.classList.remove("is-hidden", "is-danger");
                resultNotification.classList.add("is-success");
                resultNotification.textContent = "Image successfully deleted";
                
                // Re-enable all buttons
                // enableAllButtons();
                
                // Auto-hide the notification after 5 seconds
                setTimeout(() => {
                    resultNotification.classList.add("is-hidden");
                }, 5000);
                
                // Refresh the image list
                fetchImageInfo();
            })
            .catch(error => {
                console.error('Error deleting image:', error);
                const resultNotification = document.getElementById(resultNotificationId);
                resultNotification.classList.remove("is-hidden", "is-success", "is-info");
                resultNotification.classList.add("is-danger");
                resultNotification.textContent = error.response?.data?.error || "Error deleting image";
                
                enableAllButtons();
                
                setTimeout(() => {
                    resultNotification.classList.add("is-hidden");
                }, 5000);
            });
        }
        
        function determineSource(tagData) {
            // Attention: field in API is not ready yet
            return "Local Upload";
        }

        function showDetails(details) {
            details = JSON.parse(decodeURIComponent(details)); // parse the JSON string
            
            // show default port if available
            const portsDisplay = details.default_port ? 
                `${details.default_port}` : 'Not specified';
            
            // show default entrypoint if available
            const entrypointDisplay = details.default_entrypoint ? 
                `${details.default_entrypoint}` : 'Not specified';

            const detailContent = `
                <div class="field">
                    <label class="label"><i class="fas fa-fingerprint mr-2"></i>Digest</label>
                    <div class="control">
                        <p>${details.digest || 'Not available'}</p>
                    </div>
                </div>
                <div class="field">
                    <label class="label"><i class="fa-regular fa-building mr-2"></i>Maintainer</label>
                    <div class="control">
                        <p>${details.maintainer || 'Not available'}</p>
                    </div>
                </div>
                <div class="field">
                    <label class="label"><i class="fas fa-microchip mr-2"></i>Architecture</label>
                    <div class="control">
                        <p>${details.architecture || 'Not available'}</p>
                    </div>
                </div>
                <div class="field">
                    <label class="label"><i class="fas fa-display mr-2"></i>OS</label>
                    <div class="control">
                        <p>${details.os || 'Not available'}</p>
                    </div>
                </div>
                <div class="field">
                    <label class="label"><i class="fas fa-cogs mr-2"></i>Recommended Configuration</label>
                    <div class="control">
                        <p>${details.recommended_configuration || 'Not available'}</p>
                    </div>
                </div>
                <div class="field">
                    <label class="label"><i class="fas fa-keyboard mr-2"></i>Default Ports</label>
                    <div class="control">
                        <p>${portsDisplay}</p>
                    </div>
                </div>
                <div class="field">
                    <label class="label"><i class="fas fa-terminal mr-2"></i>Default Entrypoint</label>
                    <div class="control">
                        <p>${entrypointDisplay}</p>
                    </div>
                </div>
                <div class="field">
                    <label class="label"><i class="fas fa-info mr-2"></i>Description</label>
                    <div class="control">
                        <p>${details.description || 'No description available'}</p>
                    </div>
                </div>

            `;

            const detailModal = document.createElement('div');
            detailModal.classList.add('modal', 'is-active');
            detailModal.innerHTML = `
                <div class="modal-background" onclick="closeModal()"></div>
                <div class="modal-content">
                    <div class="box">
                        <h4 class="title is-5"><i class="fas fa-info-circle mr-2"></i>Image Details</h4>
                        ${detailContent}
                        <div class="field is-grouped is-grouped-right">
                            <div class="control">
                                <button class="button" onclick="closeModal()"><i class="fas fa-times mr-2"></i>Close</button>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="modal-close is-large" aria-label="close" onclick="closeModal()"></button>
            `;
            document.body.appendChild(detailModal);
        }

        function closeModal() {
            const modal = document.querySelector('.modal.is-active');
            if (modal) modal.remove();
        }
    </script>
</body>
</html>